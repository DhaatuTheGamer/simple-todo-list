<!DOCTYPE html>
<html lang="en" class=""> 
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Todo List v4</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* --- Base font --- */
        body { font-family: 'Inter', sans-serif; }

        /* --- Theme Variables (Light/Dark) --- */
        :root {
            --bg-primary: #f9fafb; 
            --bg-secondary: #ffffff; 
            --bg-tertiary: #ffffff; 
            --bg-tertiary-hover: #f9fafb; 
            --bg-input: #ffffff; 
            --bg-button: #3b82f6; 
            --bg-button-hover: #2563eb; 
            --bg-button-danger: #ef4444; 
            --bg-button-danger-hover: #dc2626; 
            --bg-button-success: #22c55e; 
            --bg-button-success-hover: #16a34a; 
            --text-primary: #1f2937; 
            --text-secondary: #6b7280; 
            --text-tertiary: #9ca3af; 
            --text-completed: #9ca3af; 
            --text-on-button: #ffffff; 
            --text-link: #3b82f6; 
            --text-link-hover: #2563eb; 
            --border-primary: #f3f4f6; 
            --border-secondary: #e5e7eb; 
            --border-focus: #3b82f6; 
            --border-drag-over: #3b82f6; 
            --icon-default: #9ca3af; 
            --icon-hover-delete: #ef4444; 
            --icon-star-active: #f59e0b; 
            --icon-check: #ffffff; 
            --shadow-color: rgba(0, 0, 0, 0.06); 
            --shadow-color-hover: rgba(0, 0, 0, 0.1);
            --modal-overlay-bg: rgba(0, 0, 0, 0.4);
            --gradient-start: #3b82f6; 
            --gradient-end: #60a5fa; 
        }

        html.dark {
            --bg-primary: #111827; 
            --bg-secondary: #1f2937; 
            --bg-tertiary: #1f2937; 
            --bg-tertiary-hover: #374151; 
            --bg-input: #374151; 
            --bg-button: #2563eb; 
            --bg-button-hover: #1d4ed8; 
            --bg-button-danger: #dc2626; 
            --bg-button-danger-hover: #b91c1c; 
            --bg-button-success: #16a34a; 
            --bg-button-success-hover: #15803d; 
            --text-primary: #f3f4f6; 
            --text-secondary: #9ca3af; 
            --text-tertiary: #6b7280; 
            --text-completed: #6b7280; 
            --text-on-button: #ffffff; 
            --text-link: #60a5fa; 
            --text-link-hover: #93c5fd; 
            --border-primary: #374151; 
            --border-secondary: #4b5563; 
            --border-focus: #60a5fa; 
            --border-drag-over: #60a5fa; 
            --icon-default: #6b7280; 
            --icon-hover-delete: #f87171; 
            --icon-star-active: #fcd34d; 
            --icon-check: #ffffff; 
            --shadow-color: rgba(0, 0, 0, 0.25); 
            --shadow-color-hover: rgba(0, 0, 0, 0.35);
            --modal-overlay-bg: rgba(0, 0, 0, 0.6);
            --gradient-start: #2563eb; 
            --gradient-end: #3b82f6; 
        }

        /* --- Apply theme variables --- */
        body { background-color: var(--bg-primary); color: var(--text-primary); transition: background-color 0.3s ease, color 0.3s ease; }
        .bg-main-container { background-color: var(--bg-secondary); }
        .bg-list-item { background-color: var(--bg-tertiary); }
        .hover\:bg-list-item-hover:hover { background-color: var(--bg-tertiary-hover); }
        .text-main { color: var(--text-primary); }
        .text-placeholder { color: var(--text-secondary); }
        .text-meta { color: var(--text-tertiary); }
        .border-divider { border-color: var(--border-primary); }
        .border-input { border-color: var(--border-secondary); }
        .focus-visible\:border-focus:focus-visible { border-color: var(--border-focus); }
        .focus-visible\:ring-focus:focus-visible { outline: 2px solid transparent; outline-offset: 2px; box-shadow: 0 0 0 2px var(--bg-primary), 0 0 0 4px var(--border-focus); }
        .shadow-main { box-shadow: 0 6px 15px -3px var(--shadow-color); }
        .modal-overlay { background-color: var(--modal-overlay-bg); }
        .modal-content { background-color: var(--bg-secondary); }

        /* --- Button Styles --- */
        .btn {
            padding: 0.65rem 1.25rem; border-radius: 0.5rem; font-weight: 500; color: var(--text-on-button);
            transition: background-color 0.2s ease, transform 0.15s ease, box-shadow 0.2s ease;
            cursor: pointer; box-shadow: 0 1px 2px 0 var(--shadow-color);
        }
        .btn:hover { transform: translateY(-1px); box-shadow: 0 3px 6px -1px var(--shadow-color-hover); }
        .btn:active { transform: scale(0.98); box-shadow: 0 1px 1px 0 var(--shadow-color); }
        .btn:focus-visible { outline: 2px solid transparent; outline-offset: 2px; box-shadow: 0 0 0 2px var(--bg-secondary), 0 0 0 4px var(--border-focus); }
        .btn-primary { background-image: linear-gradient(to right, var(--gradient-start), var(--gradient-end)); }
        .btn-primary:hover { background-image: linear-gradient(to right, var(--gradient-start), var(--gradient-end)); filter: brightness(1.1); }
        .btn-danger { background-color: var(--bg-button-danger); }
        .btn-danger:hover { background-color: var(--bg-button-danger-hover); }
        .btn-success { background-color: var(--bg-button-success); }
        .btn-success:hover { background-color: var(--bg-button-success-hover); }
        .btn-text { background: none; border: none; padding: 0.25rem 0.5rem; margin: 0; font-weight: 500; cursor: pointer; color: var(--text-link); transition: color 0.2s ease, background-color 0.2s ease; border-radius: 0.375rem; }
        .btn-text:hover { color: var(--text-link-hover); background-color: rgba(0,0,0,0.05); }
        html.dark .btn-text:hover { background-color: rgba(255,255,255,0.08); }
        .btn-text:focus-visible { outline: 2px solid transparent; outline-offset: 2px; box-shadow: 0 0 0 2px var(--bg-secondary), 0 0 0 4px var(--border-focus); }

        /* --- Input field --- */
        #todoInput { background-color: var(--bg-input); transition: border-color 0.2s ease, box-shadow 0.2s ease; box-shadow: inset 0 1px 2px rgba(0,0,0,0.05); }
        #todoInput:focus-visible { border-color: var(--border-focus); box-shadow: inset 0 1px 2px rgba(0,0,0,0.05), 0 0 0 2px var(--border-focus); outline: none; }

        /* --- Task Item --- */
        #todoList { border: 1px solid var(--border-primary); border-radius: 0.75rem; overflow: hidden; }
        #todoList li {
            cursor: grab;
            transition: background-color 0.2s ease, opacity 0.4s ease, transform 0.4s ease, box-shadow 0.2s ease; 
            will-change: opacity, transform;
            border-bottom: 1px solid var(--border-primary);
        }
        #todoList li:last-child { border-bottom: none; }
        #todoList li button, #todoList li .checkbox-icon, #todoList li input { cursor: pointer; } 
        #todoList li.completed { cursor: default; } 
        #todoList li.editing { cursor: default; } 
        #todoList li.adding { animation: fadeIn 0.5s ease forwards; }
        #todoList li.deleting { animation: fadeOutSlide 0.5s ease forwards; }

        /* --- Drag & Drop --- */
        #todoList li.dragging {
            opacity: 0.5; background-color: var(--bg-tertiary-hover);
            box-shadow: 0 4px 8px var(--shadow-color-hover); cursor: grabbing; 
            border-color: transparent; 
        }
        #todoList li.drag-over-top { border-top: 2px solid var(--border-drag-over); }
        #todoList li.drag-over-bottom { border-bottom: 2px solid var(--border-drag-over); }

        /* --- Task Text --- */
        .todo-text { font-weight: 500; cursor: pointer; transition: color 0.3s ease; }
        #todoList li.completed span.todo-text { text-decoration: line-through; color: var(--text-completed); opacity: 0.8; font-weight: 400; cursor: default; }
        #todoList li.completed .checkbox-icon { background-color: var(--border-focus); border-color: var(--border-focus); transform: scale(1.1); }
        #todoList li.completed .checkbox-icon svg { transform: scale(1); opacity: 1; }

        /* --- Edit Input --- */
        .edit-input { 
            flex-grow: 1; border: none; padding: 0; margin: 0 0.75rem; font-weight: 500; 
            color: var(--text-primary); background-color: transparent; outline: none; 
            border-bottom: 2px solid var(--border-focus); cursor: text; line-height: inherit; height: auto; 
        }

        /* --- Checkbox --- */
        .checkbox-icon { width: 1.25rem; height: 1.25rem; border: 2px solid var(--border-secondary); border-radius: 50%; margin-right: 0.75rem; display: flex; align-items: center; justify-content: center; flex-shrink: 0; transition: background-color 0.2s ease, border-color 0.2s ease, transform 0.2s ease; }
        .checkbox-icon:hover { border-color: var(--border-focus); }
        .checkbox-icon svg { width: 0.75rem; height: 0.75rem; fill: var(--icon-check); transition: transform 0.2s ease, opacity 0.2s ease; transform: scale(0.5); opacity: 0; }

        /* --- Star icon --- */
        .star-btn { transition: transform 0.2s ease; }
        .star-btn svg { fill: var(--icon-default); transition: fill 0.2s ease, transform 0.2s ease; }
        .star-btn:hover svg { fill: var(--icon-star-active); transform: scale(1.2); }
        .star-btn:active { transform: scale(0.9); }
        #todoList li.starred .star-btn svg { fill: var(--icon-star-active); animation: starPulse 0.4s ease; }
        .star-btn:focus-visible { outline: 2px solid transparent; outline-offset: 2px; box-shadow: 0 0 0 2px var(--bg-tertiary), 0 0 0 4px var(--icon-star-active); }

        /* --- Delete icon --- */
        .delete-btn { transition: transform 0.2s ease; }
        .delete-btn svg { fill: var(--icon-default); transition: fill 0.2s ease; }
        .delete-btn:hover svg { fill: var(--icon-hover-delete); transform: scale(1.1); }
        .delete-btn:active { transform: scale(0.9); }
        .delete-btn:focus-visible { outline: 2px solid transparent; outline-offset: 2px; box-shadow: 0 0 0 2px var(--bg-tertiary), 0 0 0 4px var(--icon-hover-delete); }

        /* --- Animations --- */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeOutSlide { from { opacity: 1; transform: translateX(0); } to { opacity: 0; transform: translateX(-20px); } }
        @keyframes starPulse { 0% { transform: scale(1); } 50% { transform: scale(1.3); } 100% { transform: scale(1); } }
        @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-3px, 0, 0); } 40%, 60% { transform: translate3d(3px, 0, 0); } }
        .shake-input { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; border-color: var(--bg-button-danger) !important; }

        /* --- Modal --- */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; display: flex; justify-content: center; align-items: center; z-index: 50; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0s 0.3s linear; }
        .modal-overlay.visible { opacity: 1; visibility: visible; transition: opacity 0.3s ease, visibility 0s 0s linear; }
        .modal-content { padding: 1.5rem; border-radius: 0.75rem; max-width: 90%; width: 24rem; text-align: center; transform: scale(0.95); opacity: 0; transition: transform 0.3s ease, opacity 0.3s ease; box-shadow: var(--shadow-main); } 
        .modal-overlay.visible .modal-content { transform: scale(1); opacity: 1; }

        /* --- Sidebar --- */
        #sidebar { width: 250px; transition: transform 0.3s ease-in-out; transform: translateX(0); flex-shrink: 0; height: 100vh; position: fixed; top: 0; left: 0; z-index: 40; background-color: var(--bg-secondary); border-right: 1px solid var(--border-primary); box-shadow: 2px 0 5px rgba(0,0,0,0.05); }
        #sidebar.collapsed { transform: translateX(-100%); }
        #mainContent { transition: margin-left 0.3s ease-in-out; margin-left: 250px; width: calc(100% - 250px); padding: 2rem; }
        #mainContent.sidebar-collapsed { margin-left: 0; width: 100%; }
        .sidebar-link { transition: background-color 0.2s ease, color 0.2s ease, border-left-color 0.2s ease; border-left: 3px solid transparent; }
        .sidebar-link.active { background-color: var(--bg-tertiary-hover); color: var(--text-primary); font-weight: 600; border-left-color: var(--border-focus); }
        .sidebar-link:not(.active) { color: var(--text-secondary); }
        .sidebar-link:not(.active):hover { color: var(--text-primary); }
        .sidebar-link:focus-visible { outline: none; background-color: var(--bg-tertiary-hover); box-shadow: inset 0 0 0 2px var(--border-focus); }

        /* --- Theme Toggle --- */
        #themeToggleBtn { position: relative; overflow: hidden; width: 2.5rem; height: 2.5rem; }
        #themeToggleBtn svg { transition: transform 0.4s ease, opacity 0.4s ease; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(0deg); opacity: 1; }
        #themeToggleBtn svg.icon-hidden { opacity: 0; pointer-events: none; }
        #themeToggleBtn .icon-sun.icon-hidden { transform: translate(-50%, -150%) rotate(-90deg); }
        #themeToggleBtn .icon-moon.icon-hidden { transform: translate(-50%, 50%) rotate(90deg); }
        #themeToggleBtn:focus-visible { outline: 2px solid transparent; outline-offset: 2px; box-shadow: 0 0 0 2px var(--bg-secondary), 0 0 0 4px var(--border-focus); }

        /* --- Empty State --- */
        .empty-state-container { text-align: center; padding: 3rem 1rem; opacity: 0.6; transition: opacity 0.3s ease; }
        .empty-state-container svg { width: 100px; height: 100px; margin: 0 auto 1.5rem; } 
        .empty-state-container p { color: var(--text-secondary); font-size: 1rem; }

        /* --- Utility --- */
        .hidden { display: none !important; }

        /* --- Body scroll --- */
        html, body { min-height: 100vh; }
        body::-webkit-scrollbar { display: none; } 
        body { -ms-overflow-style: none; scrollbar-width: none; } 

    </style>
</head>
<body class="overflow-x-hidden"> 
    <aside id="sidebar" class="p-4 flex flex-col">
        <h2 class="text-xl font-semibold mb-6 text-main px-3">Filters</h2>
        <nav class="flex-grow">
            <ul>
                <li><button data-filter="all" class="sidebar-link w-full text-left p-3 rounded-r-md hover:bg-tertiary-hover flex items-center active"><svg class="w-5 h-5 mr-3 flex-shrink-0" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M3 4H21V6H3V4ZM3 11H21V13H3V11ZM3 18H21V20H3V18Z"></path></svg>All Tasks</button></li>
                <li><button data-filter="starred" class="sidebar-link w-full text-left p-3 rounded-r-md hover:bg-tertiary-hover flex items-center"><svg class="w-5 h-5 mr-3 flex-shrink-0" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 17.27L18.18 21L16.54 13.97L22 9.24L14.81 8.63L12 2L9.19 8.63L2 9.24L7.46 13.97L5.82 21L12 17.27Z"></path></svg>Starred</button></li>
                <li><button data-filter="active" class="sidebar-link w-full text-left p-3 rounded-r-md hover:bg-tertiary-hover flex items-center"><svg class="w-5 h-5 mr-3 flex-shrink-0" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C17.52 2 22 6.48 22 12C22 17.52 17.52 22 12 22C6.48 22 2 17.52 2 12C2 6.48 6.48 2 12 2ZM12 4C7.58 4 4 7.58 4 12C4 16.42 7.58 20 12 20C16.42 20 20 16.42 20 12C20 7.58 16.42 4 12 4Z"></path></svg>Active</button></li>
                <li><button data-filter="completed" class="sidebar-link w-full text-left p-3 rounded-r-md hover:bg-tertiary-hover flex items-center"><svg class="w-5 h-5 mr-3 flex-shrink-0" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-2.29-5.71l-1.42-1.41L10 14.17l4.29-4.29 1.41 1.41L10 17l-2.29-2.71z"></path></svg>Completed</button></li>
            </ul>
        </nav>
        <div class="mt-auto p-3 text-sm text-meta" id="sidebarTaskCount"></div>
    </aside>

    <div id="mainContent">
        <header class="flex justify-between items-center mb-8">
            <button id="sidebarToggleBtn" class="p-2 rounded-md hover:bg-tertiary-hover focus-visible:ring-focus" aria-label="Toggle Sidebar">
                <svg class="w-6 h-6 text-main" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M3 4H21V6H3V4ZM3 11H21V13H3V11ZM3 18H21V20H3V18Z"></path></svg>
            </button>
            <button id="themeToggleBtn" class="p-2 rounded-full hover:bg-tertiary-hover flex items-center justify-center focus-visible:ring-focus" aria-label="Toggle Theme">
                <svg id="themeIconSun" class="icon-sun w-6 h-6 text-main" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 9c-1.65 0-3 1.35-3 3s1.35 3 3 3 3-1.35 3-3-1.35-3-3-3zm0 8c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zM1 11h2c.55 0 1 .45 1 1s-.45 1-1 1H1c-.55 0-1-.45-1-1s.45-1 1-1zm19.99 0h2c.55 0 1 .45 1 1s-.45 1-1 1h-2c-.55 0-1-.45-1-1s.45-1 1-1zM11 1v2c0 .55.45 1 1 1s1-.45 1-1V1c0-.55-.45-1-1-1s-1 .45-1 1zm0 19.99v2c0 .55.45 1 1 1s1-.45 1-1v-2c0-.55-.45-1-1-1s-1 .45-1 1zM5.64 4.22l1.41 1.41c.39.39.39 1.02 0 1.41-.39.39-1.02.39-1.41 0L4.22 5.64c-.39-.39-.39-1.02 0-1.41.39-.39 1.03-.39 1.42 0zm12.73 12.73l1.41 1.41c.39.39.39 1.02 0 1.41-.39.39-1.02.39-1.41 0l-1.41-1.41c-.39-.39-.39-1.02 0-1.41.39-.39 1.02-.39 1.41 0zm1.41-12.73l-1.41 1.41c-.39.39-1.02.39-1.41 0-.39-.39-.39-1.02 0-1.41l1.41-1.41c.39-.39 1.02-.39 1.41 0 .39.39.39 1.02 0 1.41zm-12.73 12.73l-1.41 1.41c-.39.39-1.02.39-1.41 0-.39-.39-.39-1.02 0-1.41l1.41-1.41c.39-.39.39 1.02 0 1.41.39.39 1.02.39 1.41 0z"></path></svg>
                <svg id="themeIconMoon" class="icon-moon w-6 h-6 text-main" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zm-1.1 14.41c-2.98-.53-5.31-3.11-5.31-6.14 0-3.45 2.8-6.25 6.25-6.25.3 0 .59.02.88.07-3.45.91-6.07 4.06-6.07 7.76 0 1.95.72 3.73 1.9 5.11-.47-.1-.92-.25-1.35-.45z"></path></svg>
            </button>
        </header>

        <div class="w-full max-w-2xl mx-auto bg-main-container rounded-xl shadow-main p-6 md:p-8">
            <h1 class="text-3xl font-bold mb-2 text-center text-main">My Todo List</h1>
            <p id="taskCount" class="text-center text-meta text-sm mb-6">Loading tasks...</p>

            <div class="flex mb-8 shadow-sm rounded-lg">
                <input type="text" id="todoInput" class="flex-grow border border-input rounded-l-lg p-3 text-main bg-input focus:outline-none focus-visible:border-focus focus-visible:ring-focus transition duration-150 placeholder-placeholder" placeholder="Add a new task..." aria-label="Add a new task">
                <button id="addTodoBtn" class="btn btn-primary rounded-l-none px-5">Add</button>
            </div>
            <p id="inputError" class="text-red-500 text-sm -mt-4 mb-4 hidden">Task cannot be empty!</p>
            
            <div id="listContainer">
                <ul id="todoList" class=""></ul>
                <div id="clearCompletedContainer" class="text-right mt-4 hidden"><button id="clearCompletedBtn" class="btn-text">Clear Completed Tasks</button></div>
                <div id="emptyListMessage" class="empty-state-container hidden"><svg class="w-[100px] h-[100px] mx-auto mb-6 text-secondary" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M21.79,11.15,12.8,2.16a1.67,1.67,0,0,0-2.36,0L1.45,11.15a1.5,1.5,0,0,0-.09,2.12l.09.09,8.79,9a1.8,1.8,0,0,0,2.54,0l9-9,.09-.09A1.5,1.5,0,0,0,21.79,11.15ZM12.05,19.5,4.8,12.25,11.3,5.76a.67.67,0,0,1,.94,0l6.5,6.49Z M10.38,11.42a1,1,0,0,0,1.41,0l4-4a1,1,0,0,0-1.41-1.41L11.09,9.3,9.71,7.91a1,1,0,0,0-1.41,1.41Z"/></svg><p>No tasks here yet. Add one above!</p></div>
                <div id="emptyFilterMessage" class="empty-state-container hidden">
                    <svg class="w-[100px] h-[100px] mx-auto mb-6 text-secondary" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                      <path d="M10 18a7.952 7.952 0 0 0 4.897-1.688l4.396 4.396 1.414-1.414-4.396-4.396A7.952 7.952 0 0 0 18 10c0-4.411-3.589-8-8-8s-8 3.589-8 8 3.589 8 8 8zm0-14c3.309 0 6 2.691 6 6s-2.691 6-6 6-6-2.691-6-6 2.691-6 6-6z"/>
                    </svg>
                    <p>No tasks match the current filter.</p>
                </div>
            </div>
        </div>
    </div>

    <div id="confirmationModal" class="modal-overlay">
        <div class="modal-content">
            <p class="text-main text-lg mb-6">This will permanently delete the task. Are you sure?</p>
            <div class="flex justify-center space-x-4">
                <button id="confirmDeleteBtn" class="btn btn-success">Sure</button>
                <button id="cancelDeleteBtn" class="btn btn-danger">Nope</button>
            </div>
        </div>
    </div>

    <div id="clearConfirmationModal" class="modal-overlay">
        <div class="modal-content">
            <p class="text-main text-lg mb-6">Delete all completed tasks permanently?</p>
            <div class="flex justify-center space-x-4">
                <button id="confirmClearBtn" class="btn btn-success">Yes, Clear</button>
                <button id="cancelClearBtn" class="btn btn-danger">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        // --- DOM Elements ---
        const todoInput = document.getElementById('todoInput');
        const addTodoBtn = document.getElementById('addTodoBtn');
        const todoList = document.getElementById('todoList'); 
        const emptyListMessage = document.getElementById('emptyListMessage');
        const emptyFilterMessage = document.getElementById('emptyFilterMessage');
        const confirmationModal = document.getElementById('confirmationModal');
        const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
        const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
        const sidebar = document.getElementById('sidebar');
        const mainContent = document.getElementById('mainContent');
        const sidebarToggleBtn = document.getElementById('sidebarToggleBtn');
        const themeToggleBtn = document.getElementById('themeToggleBtn');
        const themeIconSun = document.getElementById('themeIconSun');
        const themeIconMoon = document.getElementById('themeIconMoon');
        const filterButtons = document.querySelectorAll('.sidebar-link'); 
        const inputError = document.getElementById('inputError');
        const taskCountElement = document.getElementById('taskCount');
        const sidebarTaskCountElement = document.getElementById('sidebarTaskCount');
        const clearCompletedBtn = document.getElementById('clearCompletedBtn');
        const clearCompletedContainer = document.getElementById('clearCompletedContainer');
        const clearConfirmationModal = document.getElementById('clearConfirmationModal');
        const confirmClearBtn = document.getElementById('confirmClearBtn');
        const cancelClearBtn = document.getElementById('cancelClearBtn');

        // --- App State ---
        let todoIdToDelete = null; 
        let currentFilter = 'all'; 
        let isSidebarCollapsed = localStorage.getItem('sidebarCollapsed') === 'true'; 
        let currentlyEditing = null; 
        let draggedItem = null; 

        // --- Event Listeners (Initial Setup) ---
        addTodoBtn.addEventListener('click', addTodo); 
        todoInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') addTodo(); else clearInputError(); }); 
        todoList.addEventListener('click', handleListClick); 
        todoList.addEventListener('dblclick', handleListDoubleClick); 
        document.addEventListener('DOMContentLoaded', initializeApp); 
        confirmDeleteBtn.addEventListener('click', handleConfirmDelete); 
        cancelDeleteBtn.addEventListener('click', handleCancelDelete); 
        confirmationModal.addEventListener('click', (e) => e.target === confirmationModal && handleCancelDelete()); 
        clearCompletedBtn.addEventListener('click', showClearConfirmationModal); 
        confirmClearBtn.addEventListener('click', handleConfirmClear); 
        cancelClearBtn.addEventListener('click', hideClearConfirmationModal); 
        clearConfirmationModal.addEventListener('click', (e) => e.target === clearConfirmationModal && hideClearConfirmationModal()); 
        document.addEventListener('keydown', handleGlobalKeyDown); 
        sidebarToggleBtn.addEventListener('click', toggleSidebar); 
        filterButtons.forEach(button => button.addEventListener('click', handleFilterClick)); 
        themeToggleBtn.addEventListener('click', toggleTheme); 

        // --- Drag & Drop Event Listeners ---
        todoList.addEventListener('dragstart', handleDragStart);     
        todoList.addEventListener('dragend', handleDragEnd);         
        todoList.addEventListener('dragover', handleDragOver);       
        todoList.addEventListener('dragenter', handleDragEnter);     
        todoList.addEventListener('dragleave', handleDragLeave);     
        todoList.addEventListener('drop', handleDrop);               


        // --- Initialization ---
        function initializeApp() {
            loadTheme(); 
            applyInitialSidebarState(); 
            loadTodos(); 
        }

        // --- Core Functions ---
        function addTodo() {
            const todoText = todoInput.value.trim(); 
            if (todoText === '') { 
                showInputError("Task cannot be empty!"); 
                return; 
            }
            clearInputError(); 
            const todo = { text: todoText, completed: false, id: Date.now(), starred: false };
            const todos = getTodosFromStorage();
            todos.unshift(todo); 
            saveTodosToStorage(todos);
            renderTodoItem(todo); 
            const newItem = todoList.querySelector(`li[data-id="${todo.id}"]`);
            if (newItem) {
                newItem.classList.add('adding'); 
                newItem.addEventListener('animationend', () => newItem.classList.remove('adding'), { once: true });
            }
            applyFilter(); updateTaskCount(); updateClearButtonVisibility(); updateEmptyMessageVisibility(); 
            todoInput.value = ''; todoInput.focus(); 
        }

        function renderTodoItem(todo) {
            const li = document.createElement('li');
            li.classList.add('flex', 'items-center', 'bg-list-item', 'hover:bg-list-item-hover', 'transition', 'p-0'); 
            li.dataset.id = todo.id;
            li.dataset.starred = todo.starred;
            li.dataset.completed = todo.completed;
            li.draggable = !todo.completed;
            li.style.cursor = todo.completed ? 'default' : 'grab';
            if (todo.completed) li.classList.add('completed');
            if (todo.starred) li.classList.add('starred');

            const contentWrapper = document.createElement('div');
            contentWrapper.classList.add('flex', 'items-center', 'flex-grow', 'min-w-0', 'py-3', 'pl-4', 'pr-2'); 
            const checkbox = document.createElement('div');
            checkbox.classList.add('checkbox-icon');
            checkbox.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>`;
            checkbox.dataset.action = 'toggleComplete'; 
            checkbox.setAttribute('role', 'checkbox'); checkbox.setAttribute('aria-checked', todo.completed); checkbox.setAttribute('aria-label', 'Mark task as complete');
            const textSpan = document.createElement('span');
            textSpan.textContent = todo.text;
            textSpan.classList.add('todo-text', 'flex-grow', 'text-main', 'mx-3', 'min-w-0', 'truncate'); 
            contentWrapper.appendChild(checkbox); contentWrapper.appendChild(textSpan); 

            const buttonWrapper = document.createElement('div');
            buttonWrapper.classList.add('flex', 'items-center', 'flex-shrink-0', 'pr-3', 'py-3'); 
            const starBtn = document.createElement('button');
            starBtn.classList.add('star-btn', 'p-1', 'rounded-full'); 
            starBtn.dataset.action = 'star'; 
            starBtn.innerHTML = `<svg class="w-5 h-5 pointer-events-none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 17.27L18.18 21L16.54 13.97L22 9.24L14.81 8.63L12 2L9.19 8.63L2 9.24L7.46 13.97L5.82 21L12 17.27Z"></path></svg>`;
            starBtn.setAttribute('aria-label', todo.starred ? 'Unstar task' : 'Star task'); starBtn.setAttribute('aria-pressed', todo.starred);
            const deleteBtn = document.createElement('button');
            deleteBtn.classList.add('delete-btn', 'ml-2', 'p-1', 'rounded-full'); 
            deleteBtn.dataset.action = 'delete'; 
            deleteBtn.innerHTML = `<svg class="w-5 h-5 pointer-events-none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"></path></svg>`;
            deleteBtn.setAttribute('aria-label', 'Delete task');
            buttonWrapper.appendChild(starBtn); buttonWrapper.appendChild(deleteBtn);

            li.appendChild(contentWrapper); li.appendChild(buttonWrapper);
            // Render items in the order they are loaded from storage (respects drag/drop)
            todoList.appendChild(li); 
        }

        // --- Event Handlers ---
        function handleListClick(event) {
            if (currentlyEditing !== null) return; 
            const target = event.target; 
            const li = target.closest('li[data-id]'); 
            if (!li) return; 
            const todoId = Number(li.dataset.id); 
            const actionTarget = target.closest('[data-action]'); 
            if (actionTarget) {
                const action = actionTarget.dataset.action; 
                if (action === 'delete') showConfirmationModal(todoId); 
                else if (action === 'star') toggleStar(todoId, li, actionTarget); 
                else if (action === 'toggleComplete') toggleComplete(todoId, li, actionTarget); 
            } 
        }
        
        function handleListDoubleClick(event) {
            const target = event.target;
            if (target.classList.contains('todo-text') && !target.closest('li.completed')) {
                const li = target.closest('li[data-id]');
                if (li && currentlyEditing === null) { 
                    enterEditMode(li, target, Number(li.dataset.id)); 
                }
            }
        }
        
        function handleGlobalKeyDown(event) {
             if (event.key === 'Escape') {
                 if (confirmationModal.classList.contains('visible')) handleCancelDelete(); 
                 if (clearConfirmationModal.classList.contains('visible')) hideClearConfirmationModal(); 
             }
        }

        // --- Edit Mode ---
        function enterEditMode(li, textSpan, todoId) {
            currentlyEditing = todoId; li.classList.add('editing'); li.draggable = false; li.style.cursor = 'default'; 
            textSpan.classList.add('hidden'); 
            const currentText = textSpan.textContent;
            const input = document.createElement('input');
            input.type = 'text'; input.value = currentText; input.classList.add('edit-input'); input.dataset.action = 'editInput'; 
            const checkbox = li.querySelector('.checkbox-icon'); checkbox.after(input); 
            input.focus(); input.select(); 
            input.addEventListener('blur', () => saveEdit(li, input, todoId, false), { once: true }); 
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') { e.preventDefault(); input.blur(); } 
                else if (e.key === 'Escape') { saveEdit(li, input, todoId, true); }
            });
        }

        function saveEdit(li, input, todoId, isCancelled) {
             if (currentlyEditing !== todoId) return; 
             const textSpan = li.querySelector('.todo-text');
             const newText = input.value.trim();
             input.remove(); textSpan.classList.remove('hidden'); li.classList.remove('editing');
             const isCompleted = li.classList.contains('completed');
             li.draggable = !isCompleted; li.style.cursor = isCompleted ? 'default' : 'grab'; 
             currentlyEditing = null; 
             if (!isCancelled && newText !== '' && newText !== textSpan.textContent) {
                 textSpan.textContent = newText; updateTodoInStorage(todoId, { text: newText }); 
             }
        }

        // --- Action Handlers ---
        function toggleComplete(todoId, li, checkbox) {
            const isCompleted = !li.classList.contains('completed'); 
            li.classList.toggle('completed', isCompleted); li.dataset.completed = isCompleted; checkbox.setAttribute('aria-checked', isCompleted); 
            li.draggable = !isCompleted; li.style.cursor = isCompleted ? 'default' : 'grab'; 
            updateTodoInStorage(todoId, { completed: isCompleted });
            applyFilter(); updateTaskCount(); updateClearButtonVisibility(); updateEmptyMessageVisibility();
        }

        function toggleStar(todoId, li, starBtn) {
            const isStarred = !li.classList.contains('starred'); 
            li.classList.toggle('starred', isStarred); li.dataset.starred = isStarred; 
            starBtn.setAttribute('aria-label', isStarred ? 'Unstar task' : 'Star task'); starBtn.setAttribute('aria-pressed', isStarred); 
            updateTodoInStorage(todoId, { starred: isStarred });
            applyFilter(); updateEmptyMessageVisibility(); 
        }

        function deleteTodo(todoId) {
            const liToDelete = todoList.querySelector(`li[data-id="${todoId}"]`);
            if (liToDelete) {
                liToDelete.classList.add('deleting');
                liToDelete.addEventListener('animationend', () => {
                    liToDelete.remove();
                    const todos = getTodosFromStorage().filter(todo => todo.id !== todoId);
                    saveTodosToStorage(todos);
                    updateTaskCount(); updateClearButtonVisibility(); updateEmptyMessageVisibility();
                }, { once: true });
            } else {
                 console.warn("Delete failed: Element not found visually:", todoId);
                 const todos = getTodosFromStorage().filter(todo => todo.id !== todoId);
                 saveTodosToStorage(todos);
                 updateTaskCount(); updateClearButtonVisibility(); updateEmptyMessageVisibility();
            }
        }

        // --- Input Error Handling ---
        function showInputError(message) {
            inputError.textContent = message; inputError.classList.remove('hidden'); 
            todoInput.classList.add('shake-input', 'border-red-500'); 
            todoInput.addEventListener('animationend', () => todoInput.classList.remove('shake-input'), { once: true });
        }
        function clearInputError() { 
            inputError.classList.add('hidden'); todoInput.classList.remove('border-red-500'); 
        }

        // --- Modals ---
        function showConfirmationModal(todoId) { todoIdToDelete = todoId; confirmationModal.classList.add('visible'); cancelDeleteBtn.focus(); }
        function hideConfirmationModal() { todoIdToDelete = null; confirmationModal.classList.remove('visible'); }
        function handleConfirmDelete() { if (todoIdToDelete !== null) { deleteTodo(todoIdToDelete); } hideConfirmationModal(); }
        function handleCancelDelete() { hideConfirmationModal(); }
        function showClearConfirmationModal() { clearConfirmationModal.classList.add('visible'); cancelClearBtn.focus(); }
        function hideClearConfirmationModal() { clearConfirmationModal.classList.remove('visible'); }
        function handleConfirmClear() {
            const todos = getTodosFromStorage();
            const completedTodos = todos.filter(todo => todo.completed);
            const activeTodos = todos.filter(todo => !todo.completed); 
            if (completedTodos.length > 0) {
                completedTodos.forEach(todo => {
                    const li = todoList.querySelector(`li[data-id="${todo.id}"]`);
                    if (li) { li.classList.add('deleting'); li.addEventListener('animationend', () => li.remove(), { once: true }); }
                });
                setTimeout(() => { 
                    saveTodosToStorage(activeTodos); updateTaskCount(); updateClearButtonVisibility(); updateEmptyMessageVisibility(); 
                }, 50); 
            }
            hideClearConfirmationModal(); 
        }
        function updateClearButtonVisibility() { 
            const hasCompleted = getTodosFromStorage().some(todo => todo.completed); 
            clearCompletedContainer.classList.toggle('hidden', !hasCompleted); 
        }

        // --- Filtering ---
        function handleFilterClick(event) {
            if (currentlyEditing !== null) { 
                const li = todoList.querySelector(`li[data-id="${currentlyEditing}"]`); 
                const input = li?.querySelector('.edit-input'); 
                if (li && input) { saveEdit(li, input, currentlyEditing, false); } 
            }
            const selectedFilter = event.currentTarget.dataset.filter; 
            if (selectedFilter === currentFilter) return; 
            currentFilter = selectedFilter; 
            filterButtons.forEach(button => button.classList.toggle('active', button.dataset.filter === currentFilter));
            applyFilter(); updateEmptyMessageVisibility(); 
        }

        function applyFilter() {
            const listItems = todoList.querySelectorAll('li'); 
            listItems.forEach(li => {
                const isStarred = li.dataset.starred === 'true'; 
                const isCompleted = li.dataset.completed === 'true'; 
                let shouldShow = true; 
                switch (currentFilter) {
                    case 'starred': shouldShow = isStarred; break; 
                    case 'active': shouldShow = !isCompleted; break; 
                    case 'completed': shouldShow = isCompleted; break; 
                    case 'all': default: shouldShow = true; break;
                }
                li.classList.toggle('hidden', !shouldShow); 
            });
        }

        // --- Task Count ---
        function updateTaskCount() {
            const todos = getTodosFromStorage(); 
            const activeTasks = todos.filter(todo => !todo.completed).length; 
            const totalTasks = todos.length;
            let countText = '';
            if (activeTasks === 0 && totalTasks > 0) { countText = 'All tasks completed!'; } 
            else if (activeTasks === 1) { countText = '1 active task'; } 
            else { countText = `${activeTasks} active tasks`; }
            taskCountElement.textContent = countText; 
            sidebarTaskCountElement.textContent = `${activeTasks} active`;
        }

        // --- Empty Messages ---
        function updateEmptyMessageVisibility() {
            const allTodos = getTodosFromStorage();
            const visibleItems = todoList.querySelectorAll('li:not(.hidden)');
            const isListEmpty = allTodos.length === 0;
            const isFilterEmpty = currentFilter !== 'all' && visibleItems.length === 0 && !isListEmpty;

            emptyListMessage.classList.toggle('hidden', !isListEmpty); 
            emptyFilterMessage.classList.toggle('hidden', !isFilterEmpty); 

            if (isFilterEmpty) { 
                const filterTextElement = emptyFilterMessage.querySelector('p');
                if (filterTextElement) {
                    switch(currentFilter) {
                        case 'starred': filterTextElement.textContent = 'No starred tasks'; break; 
                        case 'active': filterTextElement.textContent = 'No active tasks'; break; 
                        case 'completed': filterTextElement.textContent = 'No completed tasks'; break; 
                        default: filterTextElement.textContent = 'No tasks match the current filter.'; 
                    }
                }
            }

            todoList.classList.toggle('hidden', isListEmpty || isFilterEmpty);

            if (isListEmpty) { 
                clearCompletedContainer.classList.add('hidden'); 
            } else {
                 updateClearButtonVisibility(); 
            }
        }

        // --- Sidebar ---
        function applyInitialSidebarState() { 
            sidebar.classList.toggle('collapsed', isSidebarCollapsed); 
            mainContent.classList.toggle('sidebar-collapsed', isSidebarCollapsed); 
        }
        function toggleSidebar() { 
            isSidebarCollapsed = !isSidebarCollapsed; 
            sidebar.classList.toggle('collapsed', isSidebarCollapsed); 
            mainContent.classList.toggle('sidebar-collapsed', isSidebarCollapsed); 
            localStorage.setItem('sidebarCollapsed', isSidebarCollapsed); 
        }

        // --- Theme ---
        function loadTheme() { 
            const savedTheme = localStorage.getItem('theme') || 'light'; 
            const isDark = savedTheme === 'dark'; 
            document.documentElement.classList.toggle('dark', isDark); 
            themeIconSun.classList.toggle('icon-hidden', isDark); 
            themeIconMoon.classList.toggle('icon-hidden', !isDark); 
        }
        function toggleTheme() { 
            if (currentlyEditing !== null) { 
                const li = todoList.querySelector(`li[data-id="${currentlyEditing}"]`); 
                const input = li?.querySelector('.edit-input'); 
                if (li && input) { saveEdit(li, input, currentlyEditing, false); } 
            } 
            const isDark = document.documentElement.classList.toggle('dark'); 
            localStorage.setItem('theme', isDark ? 'dark' : 'light'); 
            themeIconSun.classList.toggle('icon-hidden', isDark); 
            themeIconMoon.classList.toggle('icon-hidden', !isDark); 
        }

        // --- Drag & Drop Handlers ---
        function handleDragStart(e) {
            const target = e.target;
            if (target.classList.contains('completed') || target.classList.contains('editing') || e.target.closest('button, input, .checkbox-icon, .edit-input')) {
                e.preventDefault(); return;
            }
            draggedItem = target; e.dataTransfer.effectAllowed = 'move'; e.dataTransfer.setData('text/plain', draggedItem.dataset.id); 
            setTimeout(() => { if(draggedItem) draggedItem.classList.add('dragging'); }, 0);
        }
        function handleDragEnd(e) { if (draggedItem) { draggedItem.classList.remove('dragging'); } clearDragOverIndicators(); draggedItem = null; }
        function handleDragOver(e) {
            e.preventDefault(); e.dataTransfer.dropEffect = 'move'; 
            const targetItem = e.target.closest('li[draggable="true"]'); 
            if (!targetItem || targetItem === draggedItem) { clearDragOverIndicators(); return; }
             const rect = targetItem.getBoundingClientRect(); const midpoint = rect.top + rect.height / 2; const isOverTopHalf = e.clientY < midpoint; 
             clearDragOverIndicators(targetItem); 
             if (isOverTopHalf) { targetItem.classList.remove('drag-over-bottom'); targetItem.classList.add('drag-over-top'); } 
             else { targetItem.classList.remove('drag-over-top'); targetItem.classList.add('drag-over-bottom'); }
        }
         function handleDragEnter(e) { /* Optional highlighting */ }
        function handleDragLeave(e) {
            const targetItem = e.target.closest('li');
            if (targetItem && !targetItem.contains(e.relatedTarget)) { targetItem.classList.remove('drag-over-top', 'drag-over-bottom'); }
             if (!e.currentTarget.contains(e.relatedTarget)) { clearDragOverIndicators(); }
        }
        function handleDrop(e) {
            e.preventDefault(); 
            const targetItem = e.target.closest('li[draggable="true"]');
            if (!targetItem || !draggedItem || targetItem === draggedItem) { clearDragOverIndicators(); return; }
            const dropBefore = targetItem.classList.contains('drag-over-top');
            if (dropBefore) { todoList.insertBefore(draggedItem, targetItem); } 
            else { todoList.insertBefore(draggedItem, targetItem.nextSibling); }
            targetItem.classList.remove('drag-over-top', 'drag-over-bottom');
            updateStorageOrder(); 
        }
        function clearDragOverIndicators(exceptItem = null) { document.querySelectorAll('#todoList li').forEach(li => { if (li !== exceptItem) { li.classList.remove('drag-over-top', 'drag-over-bottom'); } }); }
        function updateStorageOrder() {
            const listItems = Array.from(todoList.querySelectorAll('li'));
            const orderedIds = listItems.map(li => Number(li.dataset.id));
            const currentTodos = getTodosFromStorage();
            const orderedTodos = orderedIds.map(id => currentTodos.find(todo => todo.id === id)).filter(Boolean); 
            if (orderedTodos.length === currentTodos.length) { saveTodosToStorage(orderedTodos); } 
            else { console.error("Error updating storage order: Mismatch in todo count."); }
        }

        // --- Local Storage Functions ---
        function getTodosFromStorage() {
            try {
                const todosString = localStorage.getItem('todos'); 
                const todos = todosString ? JSON.parse(todosString) : []; 
                return todos.map(todo => ({
                    text: todo.text ?? 'Untitled Task', completed: todo.completed ?? false, 
                    id: todo.id ?? Date.now(), starred: todo.starred ?? false, 
                })).filter(todo => todo.id && typeof todo.text === 'string'); 
            } catch (e) { console.error("Error reading todos from localStorage:", e); return []; }
        }
        function saveTodosToStorage(todos) { try { localStorage.setItem('todos', JSON.stringify(todos)); } catch (e) { console.error("Error saving todos to localStorage:", e); } }
        function updateTodoInStorage(todoId, updatedProperties) {
            const todos = getTodosFromStorage(); let found = false;
            const updatedTodos = todos.map(todo => { if (todo.id === todoId) { found = true; return { ...todo, ...updatedProperties }; } return todo; });
            if (found) { saveTodosToStorage(updatedTodos); } else { console.warn("Update failed: Todo not found in storage:", todoId); }
        }
        function loadTodos() {
            const todos = getTodosFromStorage(); 
            todoList.innerHTML = ''; 
            // Render in storage order
            todos.forEach(todo => renderTodoItem(todo)); 
            applyFilter(); updateTaskCount(); updateClearButtonVisibility(); updateEmptyMessageVisibility();
        }

    </script>

</body>
</html>
